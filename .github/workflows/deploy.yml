name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate SSH Key
        run: |
          if [[ ! "${{ secrets.EC2_PRIVATE_KEY }}" =~ "BEGIN" ]]; then
            echo "::error::EC2_PRIVATE_KEY seems to be missing the '-----BEGIN ... PRIVATE KEY-----' header."
            exit 1
          fi
          # Check for newlines (simple heuristic: key should be long but have multiple lines or be very long)
          LINE_COUNT=$(echo "${{ secrets.EC2_PRIVATE_KEY }}" | wc -l)
          if [ "$LINE_COUNT" -eq 1 ]; then
             echo "::warning::EC2_PRIVATE_KEY has only 1 line. It might be missing newlines. Ensure you pasted it correctly."
          fi
          echo "EC2_PRIVATE_KEY=${{ secrets.EC2_PRIVATE_KEY }}"

      - name: Clean EC2_HOST
        run: |
          CLEAN_HOST=$(echo "${{ secrets.EC2_HOST }}" | sed -E 's|^(https?\|tcp)://||')
          echo "EC2_HOST=$CLEAN_HOST" >> $GITHUB_ENV
          echo "EC2_HOST=$CLEAN_HOST"

      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          source: "docker/app.yml,nginx/*"
          target: "/home/${{ secrets.EC2_USERNAME }}/app"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.EC2_USERNAME }}/app/docker
            
            # Pull latest images
            docker compose -f app.yml pull
            
            # Restart services
            docker compose -f app.yml up -d
            
            # Cleanup unused images
            docker system prune -f
